package kiwerk.wissensci;

import java.io.File;
import java.util.Iterator;
import java.util.Set;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import org.semanticweb.HermiT.ReasonerFactory;
import org.semanticweb.owlapi.apibinding.OWLManager;
import org.semanticweb.owlapi.model.OWLClass;
import org.semanticweb.owlapi.model.OWLDataFactory;
import org.semanticweb.owlapi.model.OWLNamedIndividual;
import org.semanticweb.owlapi.model.OWLOntology;
import org.semanticweb.owlapi.model.OWLOntologyCreationException;
import org.semanticweb.owlapi.model.OWLOntologyManager;
import org.semanticweb.owlapi.reasoner.OWLReasoner;

public class Checker 
{
    private OWLOntology ontology;
	private OWLReasoner reasoner;
	private OWLDataFactory factory;
  	private String namespace;

	public Checker(String ontoPath) throws OWLOntologyCreationException 
	{
	    OWLOntologyManager man = OWLManager.createOWLOntologyManager();
	    ontology = man.loadOntologyFromOntologyDocument(new File(ontoPath));
	    namespace = ontology.getOntologyID().getOntologyIRI().get().toString() + "#";
	    factory = man.getOWLDataFactory();
	    reasoner = new ReasonerFactory().createReasoner(ontology);
	    reasoner.precomputeInferences();
	}

	public boolean isConsistent() 
	{
	    return reasoner.isConsistent();
	}

    public boolean isSatisfiable(String clsName) 
    {
        return reasoner.isSatisfiable(getCls(clsName));
    }
    
    public void checkIfAllClassesAreSatisfiable() 
    {
        Set<OWLClass> classes = ontology.getClassesInSignature();
        
        System.out.println();
        System.out.println("Check the following classes if satisfiable:");
        
        for (Iterator<OWLClass> c = classes.iterator(); c.hasNext();) {
            System.out.println("");
            System.out.print(" - "+c.next().getIRI()+": ");
            
            if (reasoner.isSatisfiable(c)) {
                System.out.print("OK");
            } else {
                System.out.print("ERROR");
            }
        }
    }
	  
	private OWLClass getCls(String name) 
	{
	    return factory.getOWLClass(namespace, name);
	}

	public static void main(String[] args) throws OWLOntologyCreationException {
	    Checker r = new Checker("knowledge.ttl");
	    
	    System.out.println("isConsistent: " + r.isConsistent());
	    
	    // System.out.println("isSatisfiable: " + r.isSatisfiable("CR_Tractor_1X"));
	    r.checkIfAllClassesAreSatisfiable();
	}
}
